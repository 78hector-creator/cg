<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Control de Gastos Personales</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .storage-alert {
            position: absolute;
            top: 15px;
            right: 15px;
            background: rgba(255, 255, 255, 0.2);
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.85rem;
            border: 1px solid rgba(255, 255, 255, 0.3);
            backdrop-filter: blur(10px);
        }

        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            padding: 30px;
            background: #f8f9fa;
        }

        .card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.15);
        }

        .card-header {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }

        .card-icon {
            font-size: 2rem;
            margin-right: 15px;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            color: white;
        }

        .income-icon { background: linear-gradient(135deg, #27ae60, #2ecc71); }
        .expense-icon { background: linear-gradient(135deg, #e74c3c, #c0392b); }
        .balance-icon { background: linear-gradient(135deg, #3498db, #2980b9); }

        .card-title {
            font-size: 1.2rem;
            color: #2c3e50;
            font-weight: 600;
        }

        .card-amount {
            font-size: 2rem;
            font-weight: bold;
            margin-top: 10px;
        }

        .income { color: #27ae60; }
        .expense { color: #e74c3c; }
        .balance { color: #3498db; }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            padding: 0 30px 30px;
        }

        .form-section, .transactions-section {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
        }

        .section-title {
            font-size: 1.5rem;
            margin-bottom: 25px;
            color: #2c3e50;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }

        input, select, textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e8ed;
            border-radius: 10px;
            font-size: 1rem;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        .btn {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 10px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(52, 152, 219, 0.3);
        }

        .btn-danger {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
        }

        .btn-danger:hover {
            box-shadow: 0 10px 20px rgba(231, 76, 60, 0.3);
        }

        .transaction-item {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 15px;
            border-left: 4px solid #3498db;
            transition: all 0.3s ease;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .transaction-item:hover {
            background: #e9ecef;
            transform: translateX(5px);
        }

        .transaction-item.expense {
            border-left-color: #e74c3c;
        }

        .transaction-item.income {
            border-left-color: #27ae60;
        }

        .transaction-details h4 {
            color: #2c3e50;
            margin-bottom: 5px;
        }

        .transaction-meta {
            font-size: 0.9rem;
            color: #7f8c8d;
        }

        .transaction-amount {
            font-size: 1.2rem;
            font-weight: bold;
        }

        .delete-btn {
            background: none;
            border: none;
            color: #e74c3c;
            cursor: pointer;
            padding: 5px;
            border-radius: 5px;
            transition: all 0.3s ease;
        }

        .delete-btn:hover {
            background: #e74c3c;
            color: white;
        }

        .filters {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .filter-group label {
            font-size: 0.9rem;
            margin-bottom: 5px;
        }

        .filter-group select, .filter-group input {
            padding: 8px 12px;
            font-size: 0.9rem;
        }

        .no-transactions {
            text-align: center;
            color: #7f8c8d;
            font-style: italic;
            padding: 40px 20px;
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .dashboard {
                grid-template-columns: 1fr;
            }
            
            .filters {
                flex-direction: column;
            }
            
            .transaction-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }

            .storage-alert {
                position: relative;
                top: auto;
                right: auto;
                margin: 10px auto 0;
                display: block;
                text-align: center;
                width: fit-content;
            }
        }

        .export-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .btn-export {
            background: linear-gradient(135deg, #27ae60, #2ecc71);
            font-size: 0.9rem;
            padding: 10px 20px;
        }

        .btn-export:hover {
            box-shadow: 0 10px 20px rgba(39, 174, 96, 0.3);
        }

        .session-warning {
            background: linear-gradient(135deg, #f39c12, #e67e22);
            color: white;
            padding: 15px;
            margin: 20px 30px;
            border-radius: 10px;
            text-align: center;
            font-weight: 600;
            box-shadow: 0 5px 15px rgba(243, 156, 18, 0.3);
        }

        .quick-backup {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.85rem;
            margin-top: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .quick-backup:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-1px);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="storage-alert" id="storageStatus">
                <i class="fas fa-info-circle"></i>
                <span id="storageText">Verificando almacenamiento...</span>
            </div>
            <h1><i class="fas fa-wallet"></i> Control de Gastos Personales</h1>
            <p>Gestiona tus finanzas de manera inteligente</p>
            <div class="quick-backup" onclick="downloadEmergencyBackup()" id="quickBackup" style="display: none;">
                <i class="fas fa-download"></i> Descargar respaldo r√°pido
            </div>
        </div>

        <div class="session-warning" id="sessionWarning" style="display: none;">
            <i class="fas fa-exclamation-triangle"></i>
            <strong>Atenci√≥n:</strong> Los datos solo se mantendr√°n durante esta sesi√≥n. 
            <strong>Descarga un respaldo</strong> antes de cerrar esta p√°gina para no perder tus datos.
        </div>

        <div class="dashboard">
            <div class="card">
                <div class="card-header">
                    <div class="card-icon income-icon">
                        <i class="fas fa-arrow-up"></i>
                    </div>
                    <div class="card-title">Ingresos Totales</div>
                </div>
                <div class="card-amount income" id="totalIncome">$0.00</div>
            </div>

            <div class="card">
                <div class="card-header">
                    <div class="card-icon expense-icon">
                        <i class="fas fa-arrow-down"></i>
                    </div>
                    <div class="card-title">Gastos Totales</div>
                </div>
                <div class="card-amount expense" id="totalExpenses">$0.00</div>
            </div>

            <div class="card">
                <div class="card-header">
                    <div class="card-icon balance-icon">
                        <i class="fas fa-balance-scale"></i>
                    </div>
                    <div class="card-title">Balance</div>
                </div>
                <div class="card-amount balance" id="totalBalance">$0.00</div>
            </div>
        </div>

        <div class="main-content">
            <div class="form-section">
                <h2 class="section-title">
                    <i class="fas fa-plus-circle"></i>
                    Agregar Transacci√≥n
                </h2>
                
                <form id="transactionForm">
                    <div class="form-group">
                        <label for="type">Tipo de Transacci√≥n</label>
                        <select id="type" required>
                            <option value="">Seleccionar tipo</option>
                            <option value="income">Ingreso</option>
                            <option value="expense">Gasto</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="description">Descripci√≥n</label>
                        <input type="text" id="description" placeholder="Ej: Salario, Comida, Transporte..." required>
                    </div>

                    <div class="form-group">
                        <label for="amount">Cantidad</label>
                        <input type="number" id="amount" step="0.01" min="0" placeholder="0.00" required>
                    </div>

                    <div class="form-group">
                        <label for="category">Categor√≠a</label>
                        <select id="category" required>
                            <option value="">Seleccionar categor√≠a</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="date">Fecha</label>
                        <input type="date" id="date" required>
                    </div>

                    <div class="form-group">
                        <label for="notes">Notas (Opcional)</label>
                        <textarea id="notes" rows="3" placeholder="Informaci√≥n adicional..."></textarea>
                    </div>

                    <button type="submit" class="btn">
                        <i class="fas fa-save"></i>
                        Guardar Transacci√≥n
                    </button>
                </form>
            </div>

            <div class="transactions-section">
                <h2 class="section-title">
                    <i class="fas fa-list"></i>
                    Historial de Transacciones
                    <span id="transactionCount" style="font-size: 0.8rem; background: #3498db; color: white; padding: 4px 8px; border-radius: 10px; margin-left: 10px;">0</span>
                </h2>

                <div class="export-buttons">
                    <button class="btn btn-export" onclick="exportToCSV()">
                        <i class="fas fa-download"></i>
                        CSV
                    </button>
                    <button class="btn btn-export" onclick="exportToJSON()" style="background: linear-gradient(135deg, #9b59b6, #8e44ad);">
                        <i class="fas fa-save"></i>
                        JSON
                    </button>
                    <button class="btn btn-export" onclick="importFromFile()" style="background: linear-gradient(135deg, #f39c12, #e67e22);">
                        <i class="fas fa-upload"></i>
                        Importar
                    </button>
                    <button class="btn btn-danger" onclick="clearAllData()">
                        <i class="fas fa-trash"></i>
                        Limpiar
                    </button>
                    <input type="file" id="importFile" accept=".json,.csv" style="display: none;" onchange="handleFileImport(event)">
                </div>

                <div class="filters">
                    <div class="filter-group">
                        <label for="filterType">Tipo</label>
                        <select id="filterType">
                            <option value="">Todos</option>
                            <option value="income">Ingresos</option>
                            <option value="expense">Gastos</option>
                        </select>
                    </div>

                    <div class="filter-group">
                        <label for="filterCategory">Categor√≠a</label>
                        <select id="filterCategory">
                            <option value="">Todas</option>
                        </select>
                    </div>

                    <div class="filter-group">
                        <label for="filterMonth">Mes</label>
                        <input type="month" id="filterMonth">
                    </div>
                </div>

                <div id="transactionsList">
                    <div class="no-transactions">
                        <i class="fas fa-inbox" style="font-size: 3rem; color: #bdc3c7; margin-bottom: 15px;"></i>
                        <p>No hay transacciones registradas a√∫n.</p>
                        <p>¬°Comienza agregando tu primera transacci√≥n!</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Categor√≠as predefinidas
        const categories = {
            income: [
                'Salario', 'Freelance', 'Inversiones', 'Bonificaciones', 
                'Ventas', 'Renta', 'Otros ingresos'
            ],
            expense: [
                'Alimentaci√≥n', 'Transporte', 'Vivienda', 'Servicios', 
                'Salud', 'Educaci√≥n', 'Entretenimiento', 'Ropa', 
                'Tecnolog√≠a', 'Otros gastos'
            ]
        };

        // Variables globales
        let transactions = [];
        let currentEditId = null;
        let storageAvailable = false;

        // Sistema de almacenamiento h√≠brido
        const Storage = {
            // Verificar disponibilidad de localStorage
            checkAvailability() {
                try {
                    const test = '__storage_test__';
                    window.localStorage.setItem(test, test);
                    window.localStorage.removeItem(test);
                    return true;
                } catch (e) {
                    return false;
                }
            },

            // Guardar datos
            save(key, data) {
                try {
                    if (this.checkAvailability()) {
                        localStorage.setItem(key, JSON.stringify(data));
                        return true;
                    }
                    return false;
                } catch (error) {
                    console.error('Error saving data:', error);
                    return false;
                }
            },

            // Cargar datos
            load(key) {
                try {
                    if (this.checkAvailability()) {
                        const data = localStorage.getItem(key);
                        return data ? JSON.parse(data) : null;
                    }
                    return null;
                } catch (error) {
                    console.error('Error loading data:', error);
                    return null;
                }
            },

            // Eliminar datos
            remove(key) {
                try {
                    if (this.checkAvailability()) {
                        localStorage.removeItem(key);
                        return true;
                    }
                    return false;
                } catch (error) {
                    console.error('Error removing data:', error);
                    return false;
                }
            }
        };

        // Inicializaci√≥n
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });

        function initializeApp() {
            storageAvailable = Storage.checkAvailability();
            updateStorageStatus();
            loadTransactions();
            setTodayDate();
            updateCategoryOptions();
            setupEventListeners();
            updateDashboard();
            renderTransactions();
            
            // Auto-respaldo cada 5 minutos si hay datos y no hay localStorage
            if (!storageAvailable) {
                setInterval(autoReminder, 300000); // 5 minutos
            }
        }

        function updateStorageStatus() {
            const statusElement = document.getElementById('storageStatus');
            const textElement = document.getElementById('storageText');
            const warningElement = document.getElementById('sessionWarning');
            const quickBackupElement = document.getElementById('quickBackup');

            if (storageAvailable) {
                statusElement.style.background = 'rgba(39, 174, 96, 0.3)';
                statusElement.style.borderColor = 'rgba(39, 174, 96, 0.5)';
                textElement.innerHTML = '<i class="fas fa-check"></i> Datos permanentes';
            } else {
                statusElement.style.background = 'rgba(243, 156, 18, 0.3)';
                statusElement.style.borderColor = 'rgba(243, 156, 18, 0.5)';
                textElement.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Solo esta sesi√≥n';
                warningElement.style.display = 'block';
                quickBackupElement.style.display = 'inline-flex';
            }
        }

        function autoReminder() {
            if (transactions.length > 0 && !storageAvailable) {
                showNotification('üíæ Recuerda hacer respaldo de tus datos', 'warning');
            }
        }

        // Event Listeners
        function setupEventListeners() {
            document.getElementById('transactionForm').addEventListener('submit', handleFormSubmit);
            document.getElementById('type').addEventListener('change', updateCategoryOptions);
            document.getElementById('filterType').addEventListener('change', renderTransactions);
            document.getElementById('filterCategory').addEventListener('change', renderTransactions);
            document.getElementById('filterMonth').addEventListener('change', renderTransactions);

            // Aviso antes de cerrar la p√°gina si no hay localStorage
            if (!storageAvailable) {
                window.addEventListener('beforeunload', function(e) {
                    if (transactions.length > 0) {
                        e.preventDefault();
                        e.returnValue = '¬øEst√°s seguro? Tienes datos sin respaldar que se perder√°n.';
                        return e.returnValue;
                    }
                });
            }
        }

        function setTodayDate() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('date').value = today;
        }

        function updateCategoryOptions() {
            const type = document.getElementById('type').value;
            const categorySelect = document.getElementById('category');
            
            categorySelect.innerHTML = '<option value="">Seleccionar categor√≠a</option>';
            
            if (type && categories[type]) {
                categories[type].forEach(cat => {
                    categorySelect.innerHTML += `<option value="${cat}">${cat}</option>`;
                });
            }

            updateFilterCategories();
        }

        function updateFilterCategories() {
            const filterCategorySelect = document.getElementById('filterCategory');
            const currentValue = filterCategorySelect.value;
            
            filterCategorySelect.innerHTML = '<option value="">Todas</option>';
            
            const allCategories = [...categories.income, ...categories.expense];
            const uniqueCategories = [...new Set(allCategories)];
            
            uniqueCategories.forEach(cat => {
                filterCategorySelect.innerHTML += `<option value="${cat}">${cat}</option>`;
            });
            
            filterCategorySelect.value = currentValue;
        }

        function handleFormSubmit(e) {
            e.preventDefault();
            
            const formData = {
                id: currentEditId || Date.now(),
                type: document.getElementById('type').value,
                description: document.getElementById('description').value,
                amount: parseFloat(document.getElementById('amount').value),
                category: document.getElementById('category').value,
                date: document.getElementById('date').value,
                notes: document.getElementById('notes').value,
                timestamp: new Date().toISOString()
            };

            if (currentEditId) {
                updateTransaction(formData);
                currentEditId = null;
            } else {
                addTransaction(formData);
            }

            resetForm();
            saveTransactions();
            updateDashboard();
            renderTransactions();
        }

        function addTransaction(transaction) {
            transactions.unshift(transaction);
            showNotification('üí∞ Transacci√≥n agregada exitosamente', 'success');
        }

        function updateTransaction(updatedTransaction) {
            const index = transactions.findIndex(t => t.id === updatedTransaction.id);
            if (index !== -1) {
                transactions[index] = updatedTransaction;
                showNotification('‚úèÔ∏è Transacci√≥n actualizada exitosamente', 'success');
            }
        }

        function deleteTransaction(id) {
            if (confirm('¬øEst√°s seguro de que deseas eliminar esta transacci√≥n?')) {
                transactions = transactions.filter(t => t.id !== id);
                saveTransactions();
                updateDashboard();
                renderTransactions();
                showNotification('üóëÔ∏è Transacci√≥n eliminada', 'error');
            }
        }

        function resetForm() {
            document.getElementById('transactionForm').reset();
            setTodayDate();
            updateCategoryOptions();
        }

        function saveTransactions() {
            if (storageAvailable) {
                Storage.save('personalExpenses_transactions', transactions);
            }
        }

        function loadTransactions() {
            if (storageAvailable) {
                const saved = Storage.load('personalExpenses_transactions');
                transactions = saved || [];
            } else {
                transactions = [];
            }
        }

        function updateDashboard() {
            const totals = transactions.reduce((acc, transaction) => {
                if (transaction.type === 'income') {
                    acc.income += transaction.amount;
                } else {
                    acc.expenses += transaction.amount;
                }
                return acc;
            }, { income: 0, expenses: 0 });

            const balance = totals.income - totals.expenses;

            document.getElementById('totalIncome').textContent = formatCurrency(totals.income);
            document.getElementById('totalExpenses').textContent = formatCurrency(totals.expenses);
            document.getElementById('totalBalance').textContent = formatCurrency(balance);
            document.getElementById('transactionCount').textContent = transactions.length;

            const balanceElement = document.getElementById('totalBalance');
            balanceElement.className = balance >= 0 ? 'card-amount balance' : 'card-amount expense';
        }

        function renderTransactions() {
            const container = document.getElementById('transactionsList');
            const filteredTransactions = getFilteredTransactions();

            if (filteredTransactions.length === 0) {
                container.innerHTML = `
                    <div class="no-transactions">
                        <i class="fas fa-search" style="font-size: 3rem; color: #bdc3c7; margin-bottom: 15px;"></i>
                        <p>No se encontraron transacciones.</p>
                        <p>${transactions.length === 0 ? '¬°Agrega tu primera transacci√≥n!' : 'Prueba ajustando los filtros.'}</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = filteredTransactions.map(transaction => `
                <div class="transaction-item ${transaction.type}">
                    <div class="transaction-details">
                        <h4>${transaction.description}</h4>
                        <div class="transaction-meta">
                            <span><i class="fas fa-tag"></i> ${transaction.category}</span> |
                            <span><i class="fas fa-calendar"></i> ${formatDate(transaction.date)}</span>
                            ${transaction.notes ? `<br><span><i class="fas fa-sticky-note"></i> ${transaction.notes}</span>` : ''}
                        </div>
                    </div>
                    <div style="display: flex; align-items: center; gap: 15px;">
                        <div class="transaction-amount ${transaction.type}">
                            ${transaction.type === 'income' ? '+' : '-'}${formatCurrency(transaction.amount)}
                        </div>
                        <button class="delete-btn" onclick="deleteTransaction(${transaction.id})" title="Eliminar">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function getFilteredTransactions() {
            const typeFilter = document.getElementById('filterType').value;
            const categoryFilter = document.getElementById('filterCategory').value;
            const monthFilter = document.getElementById('filterMonth').value;

            return transactions.filter(transaction => {
                const matchesType = !typeFilter || transaction.type === typeFilter;
                const matchesCategory = !categoryFilter || transaction.category === categoryFilter;
                const matchesMonth = !monthFilter || transaction.date.startsWith(monthFilter);
                
                return matchesType && matchesCategory && matchesMonth;
            });
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('es-MX', {
                style: 'currency',
                currency: 'MXN'
            }).format(amount);
        }

        function formatDate(dateString) {
            const date = new Date(dateString + 'T00:00:00');
            return date.toLocaleDateString('es-MX', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
        }

        function exportToCSV() {
            if (transactions.length === 0) {
                showNotification('‚ùå No hay transacciones para exportar', 'error');
                return;
            }

            const headers = ['Fecha', 'Tipo', 'Descripci√≥n', 'Categor√≠a', 'Cantidad', 'Notas'];
            const csvContent = [
                headers.join(','),
                ...transactions.map(t => [
                    t.date,
                    t.type === 'income' ? 'Ingreso' : 'Gasto',
                    `"${t.description}"`,
                    `"${t.category}"`,
                    t.amount,
                    `"${t.notes || ''}"`
                ].join(','))
            ].join('\n');

            downloadFile(csvContent, 'text/csv', `gastos_${new Date().toISOString().split('T')[0]}.csv`);
            showNotification('üìä CSV exportado exitosamente', 'success');
        }

        function exportToJSON() {
            if (transactions.length === 0) {
                showNotification('‚ùå No hay transacciones para exportar', 'error');
                return;
            }

            const dataToExport = {
                transactions: transactions,
                exportDate: new Date().toISOString(),
                version: '1.0',
                totalTransactions: transactions.length
            };

            const jsonContent = JSON.stringify(dataToExport, null, 2);
            downloadFile(jsonContent, 'application/json', `respaldo_gastos_${new Date().toISOString().split('T')[0]}.json`);
            showNotification('üíæ Respaldo JSON creado exitosamente', 'success');
        }

        function downloadEmergencyBackup() {
            if (transactions.length === 0) {
                showNotification('‚ùå No hay datos para respaldar', 'error');
                return;
            }
            exportToJSON();
        }

        function downloadFile(content, mimeType, filename) {
            const blob = new Blob([content], { type: `${mimeType};charset=utf-8;` });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }

        function importFromFile() {
            document.getElementById('importFile').click();
        }

        function handleFileImport(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const content = e.target.result;
                    
                    if (file.name.endsWith('.json')) {
                        const importedData = JSON.parse(content);
                        if (importedData.transactions && Array.isArray(importedData.transactions)) {
                            const count = importedData.transactions.length;
                            if (confirm(`¬øDeseas importar ${count} transacciones? Se agregar√°n a tus datos existentes.`)) {
                                importedData.transactions.forEach(t => {
                                    t.id = Date.now() + Math.random();
                                    transactions.unshift(t);
                                });
                                saveTransactions();
                                updateDashboard();
                                renderTransactions();
                                showNotification(`üì• ${count} transacciones importadas exitosamente`, 'success');
                            }
                        } else {
                            showNotification('‚ùå Archivo JSON no v√°lido', 'error');
                        }
                    } else if (file.name.endsWith('.csv')) {
                        const lines = content.split('\n');
                        const imported = [];
                        
                        for (let i = 1; i < lines.length; i++) {
                            if (lines[i].trim() === '') continue;
                            
                            const values = parseCSVLine(lines[i]);
                            if (values.length >= 5) {
                                imported.push({
                                    id: Date.now() + Math.random(),
                                    date: values[0],
                                    type: values[1].toLowerCase().includes('ingreso') ? 'income' : 'expense',
                                    description: values[2],
                                    category: values[3],
                                    amount: parseFloat(values[4]) || 0,
                                    notes: values[5] || '',
                                    timestamp: new Date().toISOString()
                                });
                            }
                        }
                        
                        if (imported.length > 0 && confirm(`¬øDeseas importar ${imported.length} transacciones desde CSV?`)) {
                            imported.forEach(t => transactions.unshift(t));
                            saveTransactions();
                            updateDashboard();
                            renderTransactions();
                            showNotification(`üì• ${imported.length} transacciones importadas desde CSV`, 'success');
                        } else if (imported.length === 0) {
                            showNotification('‚ùå No se encontraron datos v√°lidos en el CSV', 'error');
                        }
                    } else {
                        showNotification('‚ùå Formato de archivo no soportado', 'error');
                    }
                } catch (error) {
                    console.error('Error al importar:', error);
                    showNotification('‚ùå Error al procesar el archivo', 'error');
                }
            };
            
            reader.readAsText(file);
            event.target.value = '';
        }

        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current.trim());
                    current = '';
                } else {
                    current += char;
                }
            }
            
            result.push(current.trim());
            return result.map(item => item.replace(/^"(.*)"$/, '$1'));
        }

        function clearAllData() {
            if (transactions.length === 0) {
                showNotification('‚ùå No hay datos para limpiar', 'error');
                return;
            }

            if (confirm('¬øEst√°s seguro de que deseas eliminar TODAS las transacciones? Esta acci√≥n no se puede deshacer.')) {
                transactions = [];
                if (storageAvailable) {
                    Storage.remove('personalExpenses_transactions');
                }
                updateDashboard();
                renderTransactions();
                showNotification('üóëÔ∏è Todos los datos han sido eliminados', 'success');
            }
        }

        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            const colors = {
                success: '#27ae60',
                error: '#e74c3c',
                warning: '#f39c12',
                info: '#3498db'
            };

            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${colors[type] || colors.success};
                color: white;
                padding: 15px 20px;
                border-radius: 10px;
                box-shadow: 0 5px 20px rgba(0,0,0,0.3);
                z-index: 10000;
                font-weight: 600;
                transform: translateX(100%);
                transition: all 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
                max-width: 300px;
                word-wrap: break-word;
            `;
            notification.textContent = message;
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.style.transform = 'translateX(0)';
            }, 100);

            setTimeout(() => {
                notification.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    if (document.body.contains(notification)) {
                        document.body.removeChild(notification);
                    }
                }, 400);
            }, 4000);
        }

        // Funciones de demostraci√≥n para pruebas
        function addSampleData() {
            const sampleTransactions = [
                {
                    id: Date.now() + 1,
                    type: 'income',
                    description: 'Salario Mensual',
                    amount: 25000,
                    category: 'Salario',
                    date: '2024-12-01',
                    notes: 'Pago de n√≥mina',
                    timestamp: new Date().toISOString()
                },
                {
                    id: Date.now() + 2,
                    type: 'expense',
                    description: 'Comida Restaurante',
                    amount: 450,
                    category: 'Alimentaci√≥n',
                    date: '2024-12-05',
                    notes: 'Cena familiar',
                    timestamp: new Date().toISOString()
                },
                {
                    id: Date.now() + 3,
                    type: 'expense',
                    description: 'Gasolina',
                    amount: 800,
                    category: 'Transporte',
                    date: '2024-12-03',
                    notes: 'Tanque completo',
                    timestamp: new Date().toISOString()
                },
                {
                    id: Date.now() + 4,
                    type: 'income',
                    description: 'Proyecto Freelance',
                    amount: 5000,
                    category: 'Freelance',
                    date: '2024-12-07',
                    notes: 'Dise√±o web',
                    timestamp: new Date().toISOString()
                }
            ];

            sampleTransactions.forEach(t => transactions.unshift(t));
            saveTransactions();
            updateDashboard();
            renderTransactions();
            showNotification('üìä Datos de ejemplo agregados', 'success');
        }

        // Agregar bot√≥n de datos de ejemplo (solo visible si no hay localStorage)
        if (!Storage.checkAvailability()) {
            document.addEventListener('DOMContentLoaded', function() {
                setTimeout(() => {
                    if (transactions.length === 0) {
                        const sampleButton = document.createElement('button');
                        sampleButton.className = 'btn btn-export';
                        sampleButton.style.background = 'linear-gradient(135deg, #16a085, #2ecc71)';
                        sampleButton.innerHTML = '<i class="fas fa-magic"></i> Agregar datos de ejemplo';
                        sampleButton.onclick = addSampleData;
                        
                        const exportButtons = document.querySelector('.export-buttons');
                        exportButtons.insertBefore(sampleButton, exportButtons.firstChild);
                    }
                }, 2000);
            });
        }

        // Agregar informaci√≥n sobre GitHub en el pie de p√°gina
        document.addEventListener('DOMContentLoaded', function() {
            const footer = document.createElement('div');
            footer.style.cssText = `
                text-align: center;
                padding: 20px;
                color: #7f8c8d;
                font-size: 0.9rem;
                background: #ecf0f1;
            `;
            footer.innerHTML = `
                <p><i class="fas fa-info-circle"></i> 
                <strong>Para uso completo:</strong> Sube este archivo a GitHub Pages para tener almacenamiento permanente.</p>
                <p style="margin-top: 5px; font-size: 0.8rem;">
                En GitHub funcionar√° autom√°ticamente con localStorage para guardar tus datos de forma permanente.
                </p>
            `;
            document.querySelector('.container').appendChild(footer);
        });
    </script>
</body>
</html>
